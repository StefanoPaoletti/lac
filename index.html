<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisi Cooper</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        .tab-active { background: #3b82f6; color: white; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3); }
        .status-good { background: #d1fae5; color: #065f46; }
        .status-ok { background: #fef3c7; color: #92400e; }
        .status-bad { background: #fee2e2; color: #991b1b; }
        .carnet-badge { background: #dbeafe; color: #1e40af; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const YEARS = ['2024', '2025', '2026', '2027'];
        const SHEET_ID = '1xoAL18bArpZ6BpSV6SNBEce2ML3xjdVZnZLmoBuoSI8';
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxf8MBGoXbTPCScjLaofVOgyjL8VSYpZsh4IXvh7YbxhK4P3gFn4mm0W8JKbEXf_TLpEA/exec';
        
        function App() {
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [password, setPassword] = useState('');
          const [showPassword, setShowPassword] = useState(false);
          const [savedPassword, setSavedPassword] = useState('');
          const [activeTab, setActiveTab] = useState('dashboard');
          const [invoices, setInvoices] = useState([]);
          const [carnet, setCarnet] = useState([]);
          const [creditNotes, setCreditNotes] = useState([]);
          const [products, setProducts] = useState({});
          const PRODUCTS = Object.keys(products).sort();
          const [selectedYear, setSelectedYear] = useState(new Date().getFullYear().toString());
          const [searchQuery, setSearchQuery] = useState('');
          const [isLoading, setIsLoading] = useState(false);
          
          // Form fattura
          const [invoiceDate, setInvoiceDate] = useState(new Date().toISOString().split('T')[0]);
          const [invoiceNumber, setInvoiceNumber] = useState('');
          const [invoiceItems, setInvoiceItems] = useState([{ product: '', quantity: '', price: '', discount: '10', vat: '4' }]);
          const [editingInvoice, setEditingInvoice] = useState(null);
          const [productDropdownOpen, setProductDropdownOpen] = useState({});
          const [productSearchQuery, setProductSearchQuery] = useState({});
          
          // Form carnet
          const [carnetDate, setCarnetDate] = useState(new Date().toISOString().split('T')[0]);
          const [carnetNumber, setCarnetNumber] = useState('');
          const [carnetItems, setCarnetItems] = useState([{ product: '', quantity: '', priceUnit: '', vat: '4' }]);
          const [editingCarnet, setEditingCarnet] = useState(null);
          
          // Form nota credito
          const [creditDate, setCreditDate] = useState(new Date().toISOString().split('T')[0]);
          const [creditProduct, setCreditProduct] = useState('');
          const [creditQuantity, setCreditQuantity] = useState('');
          const [creditPriceUnit, setCreditPriceUnit] = useState('');
          const [creditVat, setCreditVat] = useState('4');
          const [editingCredit, setEditingCredit] = useState(null);
          
          // Prodotti
          const [editingProduct, setEditingProduct] = useState(null);
          const [newProductName, setNewProductName] = useState('');
          const [newProductPrice, setNewProductPrice] = useState('');
          const [newProductCarnet, setNewProductCarnet] = useState(false);
          const [productListSearch, setProductListSearch] = useState('');
          
          // Modali
          const [modal, setModal] = useState({ show: false, type: '', title: '', message: '' });
          const [confirmModal, setConfirmModal] = useState({ show: false, title: '', message: '', onConfirm: null });
          
          useEffect(() => {
            const stored = localStorage.getItem('cooperAppPassword');
            if (stored) { setSavedPassword(stored); setIsAuthenticated(true); loadFromGoogleSheets(stored); }
          }, []);
          
          useEffect(() => {
            const handleClickOutside = (e) => { if (!e.target.closest('.relative')) setProductDropdownOpen({}); };
            document.addEventListener('mousedown', handleClickOutside);
            return () => document.removeEventListener('mousedown', handleClickOutside);
          }, []);
          
          const loadFromGoogleSheets = async (pwd = savedPassword) => {
            setIsLoading(true);
            try {
              const response = await fetch(SCRIPT_URL);
              if (!response.ok) throw new Error('Errore server: ' + response.status);
              const data = await response.json();
              
              const invoiceMap = {};
              (data.invoices || []).forEach(row => {
                if (!invoiceMap[row.id]) {
                  invoiceMap[row.id] = { id: row.id, year: row.year, date: String(row.date).split('T')[0], number: row.number, items: [] };
                }
                invoiceMap[row.id].items.push({ product: row.product, quantity: row.quantity, priceGross: row.priceGross, priceNet: row.priceNet, discount: row.discount || 0, vat: row.vat });
              });
              setInvoices(Object.values(invoiceMap));
              
              const carnetMap = {};
              (data.carnet || []).forEach(row => {
                if (!carnetMap[row.id]) {
                  carnetMap[row.id] = { id: row.id, year: row.year, date: String(row.date).split('T')[0], number: row.number, items: [] };
                }
                carnetMap[row.id].items.push({ product: row.product, quantity: row.quantity, priceUnit: row.priceUnit, vat: row.vat, total: row.total });
              });
              setCarnet(Object.values(carnetMap));
              
              setCreditNotes(data.creditNotes || []);
              setProducts(data.products || {});
            } catch (error) {
              setModal({ show: true, type: 'error', title: 'Errore caricamento', message: error.message });
            }
            setIsLoading(false);
          };
          
          const saveToGoogleSheets = async (action, payload, skipReload = false) => {
            if (!savedPassword) return false;
            setIsLoading(true);
            try {
              await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ password: savedPassword, action, ...payload }), mode: 'no-cors' });
              await new Promise(r => setTimeout(r, 1500));
              if (!skipReload) await loadFromGoogleSheets();
              else setIsLoading(false);
              return true;
            } catch (error) {
              setModal({ show: true, type: 'error', title: 'Errore', message: error.message });
              setIsLoading(false);
              return false;
            }
          };
          
          const handleLogin = async () => {
            if (!password) return setModal({ show: true, type: 'warning', title: 'Password richiesta', message: 'Inserisci la password.' });
            setIsLoading(true);
            try {
              const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ password, action: 'testPassword' }) });
              const result = await response.json();
              if (result.success === false) { setIsLoading(false); return setModal({ show: true, type: 'error', title: 'Password errata', message: 'Password non corretta.' }); }
              localStorage.setItem('cooperAppPassword', password);
              setSavedPassword(password);
              setIsAuthenticated(true);
              await loadFromGoogleSheets(password);
            } catch (error) {
              setIsLoading(false);
              setModal({ show: true, type: 'error', title: 'Errore login', message: 'Impossibile verificare la password.' });
            }
          };
          
          const handleLogout = () => {
            localStorage.removeItem('cooperAppPassword');
            setSavedPassword(''); setIsAuthenticated(false); setPassword('');
            setInvoices([]); setCarnet([]); setCreditNotes([]); setProducts({});
          };
          
          // Fatture
          const addInvoiceItem = () => setInvoiceItems([...invoiceItems, { product: '', quantity: '', price: '', discount: '10', vat: '4' }]);
          const removeInvoiceItem = i => setInvoiceItems(invoiceItems.filter((_, idx) => idx !== i));
          const updateInvoiceItem = (i, field, value) => { const u = [...invoiceItems]; u[i][field] = value; setInvoiceItems(u); };
          const resetInvoiceForm = () => { setEditingInvoice(null); setInvoiceDate(new Date().toISOString().split('T')[0]); setInvoiceNumber(''); setInvoiceItems([{ product: '', quantity: '', price: '', discount: '10', vat: '4' }]); };
          
          const saveInvoice = async () => {
            const validItems = invoiceItems.filter(i => i.product && i.quantity && i.price);
            if (!invoiceDate || !invoiceNumber || validItems.length === 0) return setModal({ show: true, type: 'warning', title: 'Campi obbligatori', message: 'Compila tutti i campi.' });
            const year = new Date(invoiceDate).getFullYear().toString();
            const payload = {
              id: editingInvoice ? editingInvoice.id : Date.now(), date: invoiceDate, number: invoiceNumber, year,
              items: validItems.map(item => ({ product: item.product, quantity: parseFloat(item.quantity), priceGross: parseFloat(item.price), priceNet: parseFloat(item.price) * (1 - (parseFloat(item.discount) || 0) / 100), discount: parseFloat(item.discount) || 0, vat: parseFloat(item.vat) || 4 }))
            };
            const success = await saveToGoogleSheets(editingInvoice ? 'updateInvoice' : 'saveInvoice', payload);
            if (success) { resetInvoiceForm(); setModal({ show: true, type: 'success', title: 'Salvato', message: 'Fattura salvata!' }); }
          };
          
          const deleteInvoice = id => setConfirmModal({ show: true, title: 'Elimina fattura', message: 'Sei sicuro?', onConfirm: async () => { setConfirmModal({ show: false }); await saveToGoogleSheets('deleteInvoice', { id }); } });
          const startEditInvoice = inv => { setEditingInvoice(inv); setInvoiceDate(inv.date); setInvoiceNumber(inv.number); setInvoiceItems(inv.items.map(it => ({ product: it.product, quantity: it.quantity, price: it.priceGross, discount: it.discount || '10', vat: it.vat || '4' }))); setActiveTab('invoices'); window.scrollTo({ top: 0, behavior: 'smooth' }); };
          
          // Carnet
          const addCarnetItem = () => setCarnetItems([...carnetItems, { product: '', quantity: '', priceUnit: '', vat: '4' }]);
          const removeCarnetItem = i => setCarnetItems(carnetItems.filter((_, idx) => idx !== i));
          const updateCarnetItem = (i, field, value) => { const u = [...carnetItems]; u[i][field] = value; setCarnetItems(u); };
          const resetCarnetForm = () => { setEditingCarnet(null); setCarnetDate(new Date().toISOString().split('T')[0]); setCarnetNumber(''); setCarnetItems([{ product: '', quantity: '', priceUnit: '', vat: '4' }]); };
          
          const saveCarnet = async () => {
            const validItems = carnetItems.filter(i => i.product && i.quantity && i.priceUnit);
            if (!carnetDate || !carnetNumber || validItems.length === 0) return setModal({ show: true, type: 'warning', title: 'Campi obbligatori', message: 'Compila tutti i campi.' });
            const year = new Date(carnetDate).getFullYear().toString();
            const payload = {
              id: editingCarnet ? editingCarnet.id : Date.now(), date: carnetDate, number: carnetNumber, year,
              items: validItems.map(item => ({ product: item.product, quantity: parseFloat(item.quantity), priceUnit: parseFloat(item.priceUnit), vat: parseFloat(item.vat) || 4 }))
            };
            const success = await saveToGoogleSheets(editingCarnet ? 'updateCarnet' : 'saveCarnet', payload);
            if (success) { resetCarnetForm(); setModal({ show: true, type: 'success', title: 'Salvato', message: 'Carnet salvato!' }); }
          };
          
          const deleteCarnet = id => setConfirmModal({ show: true, title: 'Elimina carnet', message: 'Sei sicuro?', onConfirm: async () => { setConfirmModal({ show: false }); await saveToGoogleSheets('deleteCarnet', { id }); } });
          const startEditCarnet = c => { setEditingCarnet(c); setCarnetDate(c.date); setCarnetNumber(c.number); setCarnetItems(c.items.map(it => ({ product: it.product, quantity: it.quantity, priceUnit: it.priceUnit, vat: it.vat || '4' }))); setActiveTab('carnet'); window.scrollTo({ top: 0, behavior: 'smooth' }); };
          
          // Note credito
          const resetCreditForm = () => { setEditingCredit(null); setCreditDate(new Date().toISOString().split('T')[0]); setCreditProduct(''); setCreditQuantity(''); setCreditPriceUnit(''); setCreditVat('4'); };
          
          const saveCreditNote = async () => {
            if (!creditDate || !creditProduct || !creditQuantity || !creditPriceUnit) return setModal({ show: true, type: 'warning', title: 'Campi obbligatori', message: 'Compila tutti i campi.' });
            const year = new Date(creditDate).getFullYear().toString();
            const payload = { id: editingCredit ? editingCredit.id : Date.now(), date: creditDate, year, product: creditProduct, quantity: parseFloat(creditQuantity), priceUnit: parseFloat(creditPriceUnit), vat: parseFloat(creditVat) || 4 };
            const success = await saveToGoogleSheets(editingCredit ? 'updateCreditNote' : 'saveCreditNote', payload);
            if (success) { resetCreditForm(); setModal({ show: true, type: 'success', title: 'Salvato', message: 'Nota credito salvata!' }); }
          };
          
          const deleteCreditNote = id => setConfirmModal({ show: true, title: 'Elimina nota', message: 'Sei sicuro?', onConfirm: async () => { setConfirmModal({ show: false }); await saveToGoogleSheets('deleteCreditNote', { id }); } });
          const startEditCredit = n => { setEditingCredit(n); setCreditDate(n.date); setCreditProduct(n.product); setCreditQuantity(n.quantity); setCreditPriceUnit(n.priceUnit); setCreditVat(n.vat || '4'); setActiveTab('credits'); window.scrollTo({ top: 0, behavior: 'smooth' }); };
          
          const exportDashboardImage = async () => {
            const el = document.getElementById('dashboard-table');
            if (!el) return;
            try {
              const canvas = await html2canvas(el, { backgroundColor: '#ffffff', scale: 2 });
              const link = document.createElement('a');
              link.download = 'cooper-margini-' + selectedYear + '-' + new Date().toISOString().split('T')[0] + '.png';
              link.href = canvas.toDataURL('image/png');
              link.click();
            } catch (err) { setModal({ show: true, type: 'error', title: 'Errore', message: err.message }); }
          };
          
          // Analisi
          const analysis = useMemo(() => {
            const result = {};
            PRODUCTS.forEach(product => {
              let totalCost = 0, totalQty = 0;
              
              const filteredInvoices = selectedYear === 'all' ? invoices : invoices.filter(i => String(i.year) === selectedYear);
              filteredInvoices.forEach(inv => {
                inv.items.forEach(item => {
                  if (item.product === product) {
                    const qty = parseFloat(item.quantity) || 0;
                    const netPrice = parseFloat(item.priceNet) || 0;
                    const vat = parseFloat(item.vat) || 4;
                    totalCost += qty * netPrice * (1 + vat / 100);
                    totalQty += qty;
                  }
                });
              });
              
              const filteredCarnet = selectedYear === 'all' ? carnet : carnet.filter(c => String(c.year) === selectedYear);
              filteredCarnet.forEach(c => {
                c.items.forEach(item => {
                  if (item.product === product) {
                    const qty = parseFloat(item.quantity) || 0;
                    const priceUnit = parseFloat(item.priceUnit) || 0;
                    const vat = parseFloat(item.vat) || 4;
                    totalCost += qty * priceUnit * (1 + vat / 100);
                    totalQty += qty;
                  }
                });
              });
              
              const filteredCredits = selectedYear === 'all' ? creditNotes : creditNotes.filter(n => String(n.year) === selectedYear);
              filteredCredits.forEach(note => {
                if (note.product === product) {
                  const qty = parseFloat(note.quantity) || 0;
                  const priceUnit = parseFloat(note.priceUnit) || 0;
                  const vat = parseFloat(note.vat) || 4;
                  totalCost -= qty * priceUnit * (1 + vat / 100);
                  totalQty -= qty;
                }
              });
              
              const avgCost = totalQty > 0 ? totalCost / totalQty : 0;
              const onlinePrice = products[product]?.onlinePrice || 0;
              const margin = onlinePrice > 0 ? ((onlinePrice - avgCost) / onlinePrice) * 100 : 0;
              const hasCarnet = products[product]?.hasCarnet || false;
              result[product] = { avgCost, onlinePrice, margin, totalQty, totalCost, hasCarnet };
            });
            return result;
          }, [invoices, carnet, creditNotes, products, selectedYear]);
          
          // SVG Icons
          const IconEyeOff = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.451 10.451 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.242 4.242L9.88 9.88" /></svg>;
          const IconEye = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" /><path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>;
          const IconRefresh = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>;
          const IconSheet = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 0 1-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0 1 12 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125" /></svg>;
          const IconLogout = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M8.25 9V5.25A2.25 2.25 0 0 1 10.5 3h6a2.25 2.25 0 0 1 2.25 2.25v13.5A2.25 2.25 0 0 1 16.5 21h-6a2.25 2.25 0 0 1-2.25-2.25V15m-3 0-3-3m0 0 3-3m-3 3H15" /></svg>;
          const IconPlus = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>;
          const IconSave = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0 1 20.25 6v12A2.25 2.25 0 0 1 18 20.25H6A2.25 2.25 0 0 1 3.75 18V6A2.25 2.25 0 0 1 6 3.75h1.5m9 0h-9" /></svg>;
          const IconTrash = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>;
          const IconEdit = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" /></svg>;
          const IconSearch = () => <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /></svg>;
          const IconInfo = () => <svg className="w-6 h-6" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="m11.25 11.25.041-.02a.75.75 0 0 1 1.063.852l-.708 2.836a.75.75 0 0 0 1.063.853l.041-.021M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9-3.75h.008v.008H12V8.25Z" /></svg>;
          const IconCamera = () => <svg className="w-4 h-4" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z" /><path strokeLinecap="round" strokeLinejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" /></svg>;
          const IconX = () => <svg className="w-12 h-12 text-red-500" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>;
          const IconWarning = () => <svg className="w-12 h-12 text-amber-500" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg>;
          const IconCheck = () => <svg className="w-12 h-12 text-green-500" fill="none" stroke="currentColor" strokeWidth="1.5" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="m4.5 12.75 6 6 9-13.5" /></svg>;
          
          // LOGIN
          if (!isAuthenticated) {
            return (
              <>
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                  <div className="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                    <h1 className="text-3xl font-bold text-gray-800 mb-6 text-center">Analisi Cooper</h1>
                    <div className="space-y-4">
                      <div className="relative">
                        <input type={showPassword ? 'text' : 'password'} value={password} onChange={e => setPassword(e.target.value)} onKeyPress={e => e.key === 'Enter' && handleLogin()} placeholder="Inserisci password" className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                        <button onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-3 text-gray-600 hover:text-gray-800">
                          {showPassword ? <IconEyeOff /> : <IconEye />}
                        </button>
                      </div>
                      <button onClick={handleLogin} className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">Accedi</button>
                    </div>
                  </div>
                </div>
                {modal.show && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10000] p-4">
                    <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                      <div className="flex items-start gap-4">
                        <div className="flex-shrink-0">{modal.type === 'error' ? <IconX /> : modal.type === 'warning' ? <IconWarning /> : <IconCheck />}</div>
                        <div className="flex-1"><h3 className="text-lg font-bold text-gray-900 mb-2">{modal.title}</h3><p className="text-gray-700">{modal.message}</p></div>
                      </div>
                      <div className="mt-6 flex justify-end"><button onClick={() => setModal({ show: false })} className="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">OK</button></div>
                    </div>
                  </div>
                )}
              </>
            );
          }
          
          // APP PRINCIPALE
          return (
            <div className="min-h-screen bg-gray-50">
              {isLoading && (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                  <div className="bg-white rounded-lg p-8 flex items-center gap-4 shadow-2xl">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600"></div>
                    <span className="text-xl font-medium">Sincronizzazione...</span>
                  </div>
                </div>
              )}
              
              {/* HEADER */}
              <div className="bg-white shadow">
                <div className="max-w-7xl mx-auto px-4 py-3 sm:py-4">
                  <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                    <h1 className="text-xl sm:text-2xl font-bold text-gray-800">Analisi Cooper</h1>
                    <div className="flex gap-2 flex-wrap">
                      <button onClick={loadFromGoogleSheets} disabled={isLoading} className="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium"><IconRefresh /><span>Ricarica</span></button>
                      <a href={'https://docs.google.com/spreadsheets/d/' + SHEET_ID + '/edit'} target="_blank" className="flex items-center gap-2 px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium"><IconSheet /><span>Sheets</span></a>
                      <button onClick={handleLogout} className="flex items-center gap-2 px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium"><IconLogout /><span>Logout</span></button>
                    </div>
                  </div>
                  <div className="flex gap-2 sm:gap-4 mt-4 sm:mt-6 overflow-x-auto pb-2 -mx-4 px-4">
                    {['dashboard', 'invoices', 'carnet', 'credits', 'products'].map(tab => (
                      <button key={tab} onClick={() => setActiveTab(tab)} className={'px-4 sm:px-6 py-2 rounded font-medium whitespace-nowrap text-sm sm:text-base transition-all ' + (activeTab === tab ? 'tab-active' : 'bg-gray-200 text-gray-700 hover:bg-gray-300')}>
                        {tab === 'dashboard' ? 'Dashboard' : tab === 'invoices' ? 'Fatture' : tab === 'carnet' ? 'Carnet' : tab === 'credits' ? 'Note Credito' : 'Prodotti'}
                      </button>
                    ))}
                  </div>
                </div>
              </div>
              
              <div className="max-w-7xl mx-auto px-4 py-8">
                
                {/* DASHBOARD */}
                {activeTab === 'dashboard' && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow p-4">
                      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                        <div className="flex items-center gap-2">
                          <h2 className="text-2xl font-bold text-gray-800">Analisi Margini</h2>
                          <div className="relative group info-icon">
                            <IconInfo />
                            <div className="absolute left-1/2 -translate-x-1/2 top-8 hidden group-hover:block z-10 w-72 px-3 py-2.5 text-sm text-white bg-gray-700 rounded-lg shadow-xl">
                              Costo = (Fatture + Carnet - Note Credito) / Quantità<br/>Margine = (Prezzo Online - Costo) / Prezzo Online
                              <div className="absolute -top-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-gray-700 transform rotate-45"></div>
                            </div>
                          </div>
                        </div>
                        <div className="flex flex-col sm:flex-row gap-3 items-stretch sm:items-center w-full sm:w-auto">
                          <select value={selectedYear} onChange={e => setSelectedYear(e.target.value)} className="px-4 py-2.5 border rounded-lg text-base bg-white font-medium">
                            <option value="all">Tutti gli anni</option>
                            {YEARS.map(y => <option key={y} value={y}>{y}</option>)}
                          </select>
                          <button onClick={exportDashboardImage} className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm font-medium"><IconCamera /><span>Esporta</span></button>
                        </div>
                      </div>
                    </div>
                    
                    <div id="dashboard-table">
                      {(() => {
                        const activeProducts = Object.entries(analysis).filter(([, d]) => d.totalQty > 0);
                        const totalCost = activeProducts.reduce((s, [, d]) => s + d.totalCost, 0);
                        const totalRevenue = activeProducts.reduce((s, [, d]) => s + d.onlinePrice * d.totalQty, 0);
                        const avgMargin = totalRevenue > 0 ? ((totalRevenue - totalCost) / totalRevenue) * 100 : 0;
                        const totalQty = activeProducts.reduce((s, [, d]) => s + d.totalQty, 0);
                        return (
                          <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-6">
                            <div className="bg-white rounded-lg shadow p-3 sm:p-5 border-l-4 border-orange-500">
                              <div className="text-xs sm:text-sm font-medium text-gray-600 mb-1">Totale Speso</div>
                              <div className="text-lg sm:text-2xl font-bold text-orange-600">€ {totalCost.toFixed(2)}</div>
                            </div>
                            <div className="bg-white rounded-lg shadow p-3 sm:p-5 border-l-4 border-blue-500">
                              <div className="text-xs sm:text-sm font-medium text-gray-600 mb-1">Incasso Potenziale</div>
                              <div className="text-lg sm:text-2xl font-bold text-blue-600">€ {totalRevenue.toFixed(2)}</div>
                            </div>
                            <div className={'bg-white rounded-lg shadow p-3 sm:p-5 border-l-4 ' + (avgMargin < 20 ? 'border-red-500' : avgMargin < 30 ? 'border-yellow-500' : 'border-green-500')}>
                              <div className="text-xs sm:text-sm font-medium text-gray-600 mb-1">Margine Medio</div>
                              <div className={'text-lg sm:text-2xl font-bold ' + (avgMargin < 20 ? 'text-red-600' : avgMargin < 30 ? 'text-yellow-600' : 'text-green-600')}>{avgMargin.toFixed(1)}%</div>
                            </div>
                            <div className="bg-white rounded-lg shadow p-3 sm:p-5 border-l-4 border-purple-500">
                              <div className="text-xs sm:text-sm font-medium text-gray-600 mb-1">Confezioni</div>
                              <div className="text-lg sm:text-2xl font-bold text-purple-600">{totalQty}</div>
                            </div>
                          </div>
                        );
                      })()}
                      
                      <div id="search-bar" className="bg-white rounded-lg shadow p-4 mb-4">
                        <div className="relative">
                          <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><IconSearch /></div>
                          <input type="text" placeholder="Cerca prodotto..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
                        </div>
                      </div>
                      
                      <div className="bg-white rounded-xl shadow overflow-hidden">
                        <div className="overflow-x-auto">
                          <table className="w-full">
                            <thead className="bg-gray-50 border-b">
                              <tr>
                                <th className="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">Prodotto</th>
                                <th className="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">Costo Reale</th>
                                <th className="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">Prezzo Online</th>
                                <th className="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">Margine</th>
                                <th className="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">Qtà</th>
                                <th className="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase">Status</th>
                              </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                              {Object.entries(analysis).filter(([, d]) => d.totalQty > 0).filter(([product]) => product.toLowerCase().includes(searchQuery.toLowerCase())).sort(([, a], [, b]) => a.margin - b.margin).map(([product, data]) => (
                                <tr key={product} className="hover:bg-gray-50">
                                  <td className="px-6 py-4 font-medium text-gray-800">{product}{data.hasCarnet && <span className="ml-2 carnet-badge">CARNET</span>}</td>
                                  <td className="px-6 py-4 text-gray-700">€ {data.avgCost.toFixed(2)}</td>
                                  <td className="px-6 py-4 font-medium text-blue-600">€ {data.onlinePrice.toFixed(2)}</td>
                                  <td className="px-6 py-4"><span className={'font-bold ' + (data.margin < 20 ? 'text-red-600' : data.margin < 30 ? 'text-yellow-600' : 'text-green-600')}>{data.margin.toFixed(1)}%</span></td>
                                  <td className="px-6 py-4 text-gray-700">{data.totalQty} pz</td>
                                  <td className="px-6 py-4"><span className={'px-3 py-1 rounded text-xs font-bold ' + (data.margin < 20 ? 'status-bad' : data.margin < 30 ? 'status-ok' : 'status-good')}>{data.margin < 20 ? 'Basso' : data.margin < 30 ? 'Buono' : 'Ottimo'}</span></td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                          {Object.entries(analysis).filter(([, d]) => d.totalQty > 0).length === 0 && <div className="text-center py-12 text-gray-500">Nessun dato. Inserisci fatture o carnet.</div>}
                        </div>
                      </div>
                    </div>
                  </div>
                )}
                
                {/* FATTURE */}
                {activeTab === 'invoices' && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow p-4 sm:p-6">
                      <h2 className="text-xl sm:text-2xl font-bold mb-2">{editingInvoice ? 'Modifica Fattura' : 'Nuova Fattura'}</h2>
                      <p className="text-sm text-gray-500 mb-4">Acquisti normali con sconto 10%</p>
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 mb-4">
                        <div><label className="block text-sm font-medium mb-1">Data</label><input type="date" value={invoiceDate} onChange={e => setInvoiceDate(e.target.value)} className="w-full px-3 py-2 border rounded-lg" /></div>
                        <div><label className="block text-sm font-medium mb-1">Numero</label><input type="text" value={invoiceNumber} onChange={e => setInvoiceNumber(e.target.value)} placeholder="es. 253013521" className="w-full px-3 py-2 border rounded-lg" /></div>
                      </div>
                      <div className="overflow-x-auto mb-4">
                        <table className="w-full text-sm">
                          <thead className="bg-gray-100"><tr><th className="px-3 py-2 text-left">Prodotto</th><th className="px-3 py-2 text-left">Qtà</th><th className="px-3 py-2 text-left">Prezzo €</th><th className="px-3 py-2 text-left">Sconto %</th><th className="px-3 py-2 text-left">IVA %</th><th className="px-3 py-2"></th></tr></thead>
                          <tbody>
                            {invoiceItems.map((item, i) => (
                              <tr key={i} className="border-b">
                                <td className="px-3 py-2 min-w-[200px]">
                                  <div className="relative">
                                    <input type="text" value={productSearchQuery['inv-'+i] !== undefined ? productSearchQuery['inv-'+i] : item.product} onChange={e => { setProductSearchQuery({...productSearchQuery, ['inv-'+i]: e.target.value}); setProductDropdownOpen({...productDropdownOpen, ['inv-'+i]: true}); }} onFocus={() => setProductDropdownOpen({...productDropdownOpen, ['inv-'+i]: true})} placeholder="Cerca..." className="w-full px-3 py-2 border rounded-lg text-sm" />
                                    {productDropdownOpen['inv-'+i] && (
                                      <div className="absolute z-50 w-full mt-1 bg-white border rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                        {PRODUCTS.filter(p => p.toLowerCase().includes((productSearchQuery['inv-'+i] || '').toLowerCase())).map(p => (
                                          <div key={p} onClick={() => { updateInvoiceItem(i, 'product', p); setProductSearchQuery({...productSearchQuery, ['inv-'+i]: undefined}); setProductDropdownOpen({}); }} className="px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm flex justify-between">
                                            <span>{p}</span>{products[p]?.hasCarnet && <span className="carnet-badge">CARNET</span>}
                                          </div>
                                        ))}
                                      </div>
                                    )}
                                  </div>
                                </td>
                                <td className="px-3 py-2"><input type="number" value={item.quantity} onChange={e => updateInvoiceItem(i, 'quantity', e.target.value)} className="w-20 px-2 py-2 border rounded-lg" /></td>
                                <td className="px-3 py-2"><input type="number" step="0.01" value={item.price} onChange={e => updateInvoiceItem(i, 'price', e.target.value)} className="w-24 px-2 py-2 border rounded-lg" /></td>
                                <td className="px-3 py-2"><input type="number" value={item.discount} onChange={e => updateInvoiceItem(i, 'discount', e.target.value)} className="w-16 px-2 py-2 border rounded-lg" /></td>
                                <td className="px-3 py-2"><input type="number" value={item.vat} onChange={e => updateInvoiceItem(i, 'vat', e.target.value)} className="w-16 px-2 py-2 border rounded-lg" /></td>
                                <td className="px-3 py-2"><button onClick={() => removeInvoiceItem(i)} className="text-red-600 hover:bg-red-50 p-2 rounded"><IconTrash /></button></td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                      <div className="flex flex-wrap gap-3">
                        <button onClick={addInvoiceItem} className="px-4 py-2 border-2 border-dashed rounded-lg hover:bg-gray-50 flex items-center gap-2"><IconPlus />Aggiungi Riga</button>
                        <button onClick={saveInvoice} disabled={isLoading} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"><IconSave />{editingInvoice ? 'Aggiorna' : 'Salva'}</button>
                        {editingInvoice && <button onClick={resetInvoiceForm} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Annulla</button>}
                      </div>
                    </div>
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold mb-4">Fatture ({invoices.length})</h2>
                      <div className="space-y-3">
                        {invoices.sort((a, b) => b.date.localeCompare(a.date)).map(inv => (
                          <div key={inv.id} className="border rounded-lg p-4 hover:bg-gray-50 flex justify-between items-start">
                            <div>
                              <div className="font-bold">{inv.number} - {inv.date}</div>
                              <div className="text-sm text-gray-600 mt-1">{inv.items.map((it, idx) => <div key={idx}>• {it.product}: {it.quantity} pz @ €{it.priceGross} (-{it.discount}%)</div>)}</div>
                            </div>
                            <div className="flex gap-2">
                              <button onClick={() => startEditInvoice(inv)} className="text-blue-600 hover:bg-blue-50 p-2 rounded"><IconEdit /></button>
                              <button onClick={() => deleteInvoice(inv.id)} className="text-red-600 hover:bg-red-50 p-2 rounded"><IconTrash /></button>
                            </div>
                          </div>
                        ))}
                        {invoices.length === 0 && <div className="text-center py-4 text-gray-500">Nessuna fattura</div>}
                      </div>
                    </div>
                  </div>
                )}
                
                {/* CARNET */}
                {activeTab === 'carnet' && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow p-4 sm:p-6">
                      <h2 className="text-xl sm:text-2xl font-bold mb-2">{editingCarnet ? 'Modifica Carnet' : 'Nuovo Carnet'}</h2>
                      <p className="text-sm text-gray-500 mb-4">Acquisti prepagati PURCHASE BANK</p>
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 mb-4">
                        <div><label className="block text-sm font-medium mb-1">Data</label><input type="date" value={carnetDate} onChange={e => setCarnetDate(e.target.value)} className="w-full px-3 py-2 border rounded-lg" /></div>
                        <div><label className="block text-sm font-medium mb-1">Numero</label><input type="text" value={carnetNumber} onChange={e => setCarnetNumber(e.target.value)} placeholder="es. 253013523" className="w-full px-3 py-2 border rounded-lg" /></div>
                      </div>
                      <div className="overflow-x-auto mb-4">
                        <table className="w-full text-sm">
                          <thead className="bg-blue-50"><tr><th className="px-3 py-2 text-left">Prodotto</th><th className="px-3 py-2 text-left">Qtà</th><th className="px-3 py-2 text-left">Prezzo Unit. €</th><th className="px-3 py-2 text-left">IVA %</th><th className="px-3 py-2 text-left">Totale</th><th className="px-3 py-2"></th></tr></thead>
                          <tbody>
                            {carnetItems.map((item, i) => {
                              const qty = parseFloat(item.quantity) || 0;
                              const price = parseFloat(item.priceUnit) || 0;
                              const vat = parseFloat(item.vat) || 4;
                              const total = qty * price * (1 + vat / 100);
                              return (
                                <tr key={i} className="border-b">
                                  <td className="px-3 py-2 min-w-[200px]">
                                    <div className="relative">
                                      <input type="text" value={productSearchQuery['car-'+i] !== undefined ? productSearchQuery['car-'+i] : item.product} onChange={e => { setProductSearchQuery({...productSearchQuery, ['car-'+i]: e.target.value}); setProductDropdownOpen({...productDropdownOpen, ['car-'+i]: true}); }} onFocus={() => setProductDropdownOpen({...productDropdownOpen, ['car-'+i]: true})} placeholder="Cerca..." className="w-full px-3 py-2 border rounded-lg text-sm" />
                                      {productDropdownOpen['car-'+i] && (
                                        <div className="absolute z-50 w-full mt-1 bg-white border rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                          {PRODUCTS.filter(p => p.toLowerCase().includes((productSearchQuery['car-'+i] || '').toLowerCase())).map(p => (
                                            <div key={p} onClick={() => { updateCarnetItem(i, 'product', p); setProductSearchQuery({...productSearchQuery, ['car-'+i]: undefined}); setProductDropdownOpen({}); }} className="px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm">{p}</div>
                                          ))}
                                        </div>
                                      )}
                                    </div>
                                  </td>
                                  <td className="px-3 py-2"><input type="number" value={item.quantity} onChange={e => updateCarnetItem(i, 'quantity', e.target.value)} className="w-20 px-2 py-2 border rounded-lg" /></td>
                                  <td className="px-3 py-2"><input type="number" step="0.01" value={item.priceUnit} onChange={e => updateCarnetItem(i, 'priceUnit', e.target.value)} className="w-24 px-2 py-2 border rounded-lg" /></td>
                                  <td className="px-3 py-2"><input type="number" value={item.vat} onChange={e => updateCarnetItem(i, 'vat', e.target.value)} className="w-16 px-2 py-2 border rounded-lg" /></td>
                                  <td className="px-3 py-2 font-medium text-blue-600">€ {total.toFixed(2)}</td>
                                  <td className="px-3 py-2"><button onClick={() => removeCarnetItem(i)} className="text-red-600 hover:bg-red-50 p-2 rounded"><IconTrash /></button></td>
                                </tr>
                              );
                            })}
                          </tbody>
                        </table>
                      </div>
                      <div className="flex flex-wrap gap-3">
                        <button onClick={addCarnetItem} className="px-4 py-2 border-2 border-dashed rounded-lg hover:bg-gray-50 flex items-center gap-2"><IconPlus />Aggiungi Riga</button>
                        <button onClick={saveCarnet} disabled={isLoading} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"><IconSave />{editingCarnet ? 'Aggiorna' : 'Salva'}</button>
                        {editingCarnet && <button onClick={resetCarnetForm} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Annulla</button>}
                      </div>
                    </div>
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold mb-4">Carnet ({carnet.length})</h2>
                      <div className="space-y-3">
                        {carnet.sort((a, b) => b.date.localeCompare(a.date)).map(c => {
                          const total = c.items.reduce((s, it) => s + (parseFloat(it.quantity) || 0) * (parseFloat(it.priceUnit) || 0) * (1 + (parseFloat(it.vat) || 4) / 100), 0);
                          return (
                            <div key={c.id} className="border-l-4 border-blue-500 border rounded-lg p-4 hover:bg-gray-50 flex justify-between items-start">
                              <div>
                                <div className="font-bold flex items-center gap-2">{c.number} - {c.date}<span className="carnet-badge">CARNET</span></div>
                                <div className="text-sm text-gray-600 mt-1">{c.items.map((it, idx) => <div key={idx}>• {it.product}: {it.quantity} pz @ €{it.priceUnit}</div>)}</div>
                                <div className="font-medium mt-2 text-blue-600">Totale: € {total.toFixed(2)}</div>
                              </div>
                              <div className="flex gap-2">
                                <button onClick={() => startEditCarnet(c)} className="text-blue-600 hover:bg-blue-50 p-2 rounded"><IconEdit /></button>
                                <button onClick={() => deleteCarnet(c.id)} className="text-red-600 hover:bg-red-50 p-2 rounded"><IconTrash /></button>
                              </div>
                            </div>
                          );
                        })}
                        {carnet.length === 0 && <div className="text-center py-4 text-gray-500">Nessun carnet</div>}
                      </div>
                    </div>
                  </div>
                )}
                
                {/* NOTE CREDITO */}
                {activeTab === 'credits' && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow p-4 sm:p-6">
                      <h2 className="text-xl sm:text-2xl font-bold mb-2">{editingCredit ? 'Modifica Nota' : 'Nuova Nota di Credito'}</h2>
                      <p className="text-sm text-gray-500 mb-4">Reso con indicazione prodotto specifico</p>
                      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 mb-4">
                        <div><label className="block text-sm font-medium mb-1">Data</label><input type="date" value={creditDate} onChange={e => setCreditDate(e.target.value)} className="w-full px-3 py-2 border rounded-lg" /></div>
                        <div><label className="block text-sm font-medium mb-1">Prodotto</label><select value={creditProduct} onChange={e => setCreditProduct(e.target.value)} className="w-full px-3 py-2 border rounded-lg"><option value="">Seleziona...</option>{PRODUCTS.map(p => <option key={p} value={p}>{p}</option>)}</select></div>
                        <div><label className="block text-sm font-medium mb-1">Quantità</label><input type="number" value={creditQuantity} onChange={e => setCreditQuantity(e.target.value)} className="w-full px-3 py-2 border rounded-lg" /></div>
                        <div><label className="block text-sm font-medium mb-1">Prezzo Unit. €</label><input type="number" step="0.01" value={creditPriceUnit} onChange={e => setCreditPriceUnit(e.target.value)} className="w-full px-3 py-2 border rounded-lg" /></div>
                        <div><label className="block text-sm font-medium mb-1">IVA %</label><input type="number" value={creditVat} onChange={e => setCreditVat(e.target.value)} className="w-full px-3 py-2 border rounded-lg" /></div>
                        <div><label className="block text-sm font-medium mb-1">Totale</label><div className="px-3 py-2 bg-gray-100 rounded-lg font-medium text-red-600">-€ {((parseFloat(creditQuantity) || 0) * (parseFloat(creditPriceUnit) || 0) * (1 + (parseFloat(creditVat) || 4) / 100)).toFixed(2)}</div></div>
                      </div>
                      <div className="flex flex-wrap gap-3">
                        <button onClick={saveCreditNote} disabled={isLoading} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"><IconSave />{editingCredit ? 'Aggiorna' : 'Salva'}</button>
                        {editingCredit && <button onClick={resetCreditForm} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Annulla</button>}
                      </div>
                    </div>
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold mb-4">Note di Credito ({creditNotes.length})</h2>
                      <div className="space-y-3">
                        {creditNotes.sort((a, b) => b.date.localeCompare(a.date)).map(note => {
                          const total = (parseFloat(note.quantity) || 0) * (parseFloat(note.priceUnit) || 0) * (1 + (parseFloat(note.vat) || 4) / 100);
                          return (
                            <div key={note.id} className="border-l-4 border-red-500 border rounded-lg p-4 hover:bg-gray-50 flex justify-between items-center">
                              <div>
                                <div className="font-bold">{note.date} - {note.product}</div>
                                <div className="text-sm text-gray-600">{note.quantity} pz @ €{note.priceUnit}</div>
                                <div className="font-medium text-red-600">-€ {total.toFixed(2)}</div>
                              </div>
                              <div className="flex gap-2">
                                <button onClick={() => startEditCredit(note)} className="text-blue-600 hover:bg-blue-50 p-2 rounded"><IconEdit /></button>
                                <button onClick={() => deleteCreditNote(note.id)} className="text-red-600 hover:bg-red-50 p-2 rounded"><IconTrash /></button>
                              </div>
                            </div>
                          );
                        })}
                        {creditNotes.length === 0 && <div className="text-center py-4 text-gray-500">Nessuna nota di credito</div>}
                      </div>
                    </div>
                  </div>
                )}
                
                {/* PRODOTTI */}
                {activeTab === 'products' && (
                  <div className="space-y-6">
                    <div className="bg-white rounded-lg shadow p-4 sm:p-6">
                      <h2 className="text-xl sm:text-2xl font-bold mb-4">{editingProduct ? 'Modifica Prodotto' : 'Nuovo Prodotto'}</h2>
                      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                        <div><label className="block text-sm font-medium mb-1">Nome</label><input type="text" value={newProductName} onChange={e => setNewProductName(e.target.value)} placeholder="es. BIOFINITY 3PK" className="w-full px-3 py-2 border rounded-lg" /></div>
                        <div><label className="block text-sm font-medium mb-1">Prezzo Online €</label><input type="number" step="0.01" value={newProductPrice} onChange={e => setNewProductPrice(e.target.value)} className="w-full px-3 py-2 border rounded-lg" /></div>
                        <div><label className="block text-sm font-medium mb-1">Opzione Carnet</label><label className="flex items-center gap-2 mt-2"><input type="checkbox" checked={newProductCarnet} onChange={e => setNewProductCarnet(e.target.checked)} className="w-5 h-5" /><span>Disponibile in carnet</span></label></div>
                      </div>
                      <div className="flex flex-wrap gap-3">
                        <button onClick={async () => {
                          if (!newProductName) return setModal({ show: true, type: 'warning', title: 'Nome richiesto', message: 'Inserisci il nome.' });
                          const action = editingProduct ? 'updateProduct' : 'addProduct';
                          const payload = editingProduct ? { oldName: editingProduct, newName: newProductName, onlinePrice: parseFloat(newProductPrice) || 0, hasCarnet: newProductCarnet } : { name: newProductName, onlinePrice: parseFloat(newProductPrice) || 0, hasCarnet: newProductCarnet };
                          const success = await saveToGoogleSheets(action, payload);
                          if (success) { setEditingProduct(null); setNewProductName(''); setNewProductPrice(''); setNewProductCarnet(false); setModal({ show: true, type: 'success', title: 'Salvato', message: 'Prodotto salvato!' }); }
                        }} disabled={isLoading} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"><IconSave />{editingProduct ? 'Aggiorna' : 'Aggiungi'}</button>
                        {editingProduct && <button onClick={() => { setEditingProduct(null); setNewProductName(''); setNewProductPrice(''); setNewProductCarnet(false); }} className="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Annulla</button>}
                      </div>
                    </div>
                    <div className="bg-white rounded-lg shadow p-6">
                      <h2 className="text-xl font-bold mb-4">Prodotti ({PRODUCTS.length})</h2>
                      <div className="mb-4">
                        <div className="relative">
                          <div className="absolute left-3 top-3 text-gray-400"><IconSearch /></div>
                          <input type="text" value={productListSearch} onChange={e => setProductListSearch(e.target.value)} placeholder="Cerca..." className="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg" />
                        </div>
                      </div>
                      <div className="space-y-2">
                        {PRODUCTS.filter(p => p.toLowerCase().includes(productListSearch.toLowerCase())).map(product => (
                          <div key={product} className="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50">
                            <div className="flex-1">
                              <div className="font-medium">{product}{products[product]?.hasCarnet && <span className="ml-2 carnet-badge">CARNET</span>}</div>
                              <div className="text-sm text-gray-600">€ {products[product]?.onlinePrice?.toFixed(2) || '0.00'}</div>
                            </div>
                            <div className="flex gap-2">
                              <button onClick={() => { setEditingProduct(product); setNewProductName(product); setNewProductPrice(products[product]?.onlinePrice || ''); setNewProductCarnet(products[product]?.hasCarnet || false); window.scrollTo({ top: 0, behavior: 'smooth' }); }} className="text-blue-600 hover:bg-blue-50 p-2 rounded"><IconEdit /></button>
                              <button onClick={() => {
                                const inUse = invoices.some(inv => inv.items.some(it => it.product === product)) || carnet.some(c => c.items.some(it => it.product === product)) || creditNotes.some(n => n.product === product);
                                if (inUse) return setModal({ show: true, type: 'warning', title: 'Prodotto in uso', message: 'Non puoi eliminare un prodotto presente in fatture, carnet o note credito.' });
                                setConfirmModal({ show: true, title: 'Elimina prodotto', message: 'Eliminare "' + product + '"?', onConfirm: async () => { setConfirmModal({ show: false }); await saveToGoogleSheets('deleteProduct', { name: product }); } });
                              }} className="text-red-600 hover:bg-red-50 p-2 rounded"><IconTrash /></button>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>
                )}
              </div>
              
              {/* MODALI */}
              {modal.show && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10000] p-4">
                  <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                    <div className="flex items-start gap-4">
                      <div className="flex-shrink-0">{modal.type === 'error' ? <IconX /> : modal.type === 'warning' ? <IconWarning /> : <IconCheck />}</div>
                      <div className="flex-1"><h3 className="text-lg font-bold text-gray-900 mb-2">{modal.title}</h3><p className="text-gray-700">{modal.message}</p></div>
                    </div>
                    <div className="mt-6 flex justify-end"><button onClick={() => setModal({ show: false })} className="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">OK</button></div>
                  </div>
                </div>
              )}
              
              {confirmModal.show && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10000] p-4">
                  <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                    <div className="flex items-start gap-4">
                      <div className="flex-shrink-0"><IconTrash /></div>
                      <div className="flex-1"><h3 className="text-lg font-bold text-gray-900 mb-2">{confirmModal.title}</h3><p className="text-gray-700">{confirmModal.message}</p></div>
                    </div>
                    <div className="mt-6 flex justify-end gap-3">
                      <button onClick={() => setConfirmModal({ show: false })} className="px-6 py-2.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium">Annulla</button>
                      <button onClick={confirmModal.onConfirm} className="px-6 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium">Elimina</button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
